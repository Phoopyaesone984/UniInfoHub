{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/announcement.css' %}">
{% endblock %}

{% block content %}
<div class="announcements-container">
    <div class="page-header">
        <h2>{{ title }}</h2>
        <p>Browse through the latest updates and important notices</p>
    </div>

{% if announcements %}
    <div class="announcements-grid">
        {% for announcement in announcements %}
        <div class="announcement-card">
            <h3 class="card-title">{{ announcement.title }}</h3>
            <div class="card-meta">
                {% if announcement.place %}
                <div class="meta-item"><i class="bi bi-geo-alt-fill"></i> {{ announcement.place }}</div>
                {% endif %}
                {% if announcement.time %}
                <div class="meta-item"><i class="bi bi-clock-fill"></i> {{ announcement.time|date:"g:i A" }}</div>
                {% endif %}
            </div>

            {% if announcement.tags %}
            <div class="card-tags">
                {% for tag in announcement.tags %}
                <span class="tag">#{{ tag }}</span>
                {% endfor %}
            </div>
            {% endif %}

            <div class="card-content collapsed" id="content-{{ forloop.counter }}">
                {{ announcement.content }}
            </div>
            <button class="see-more-btn" data-target="content-{{ forloop.counter }}" aria-expanded="false">
                Read more <i class="bi bi-arrow-right"></i>
            </button>

           {% if announcement.attachment %}
<div class="attachment mt-4 mb-3">
    {% if announcement.attachment.name|lower|slice:"-4:" == ".pdf" %}
        <a href="{{ announcement.attachment.url }}" target="_blank" class="btn btn-outline-secondary d-flex align-items-center">
            <i class="bi bi-file-earmark-fill me-2"></i> View Document (PDF)
        </a>
    {% elif announcement.attachment.name|lower|slice:"-4:" in ".png.jpg.jpeg.gif" %}
        <a href="{{ announcement.attachment.url }}" target="_blank">
            <img src="{{ announcement.attachment.url }}" class="img-fluid rounded" alt="Attachment for {{ announcement.title }}">
        </a>
    {% else %}
        <a href="{{ announcement.attachment.url }}" target="_blank" class="btn btn-outline-secondary d-flex align-items-center">
            <i class="bi bi-file-earmark-arrow-down-fill me-2"></i> Download File
        </a>
    {% endif %}
</div>
{% endif %}

            <div class="card-footer">
                <div class="posted-at">
                    <i class="bi bi-calendar-event"></i>
                    {{ announcement.created_at|date:"M d, Y" }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <i class="bi bi-megaphone"></i>
        <h3>No Announcements Yet</h3>
        <p>Check back later for updates or contact the administration if this is unexpected.</p>
        <a href="#" class="btn btn-primary">Refresh Page <i class="bi bi-arrow-repeat"></i></a>
    </div>
{% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    var grid = document.querySelector('.announcements-grid');

    // Init Masonry for re-layout only
    var msnry = new Masonry(grid, {
        itemSelector: '.announcement-card',
        columnWidth: '.announcement-card',  // use actual card width
        gutter: 24,
        percentPosition: true
    });

    document.querySelectorAll('.see-more-btn').forEach(button => {
        const targetId = button.getAttribute('data-target');
        const content = document.getElementById(targetId);

        if (content.scrollHeight <= 180) button.style.display = "none";
        else button.style.display = "inline-flex";

        button.addEventListener('click', function() {
            const expanded = this.getAttribute("aria-expanded") === "true";

            if (!expanded) {
                content.style.maxHeight = content.scrollHeight + "px";
                content.classList.remove('collapsed');
                this.innerHTML = 'Show less <i class="bi bi-arrow-up"></i>';
                this.setAttribute("aria-expanded", "true");
            } else {
                content.style.maxHeight = "180px";
                content.classList.add('collapsed');
                this.innerHTML = 'Read more <i class="bi bi-arrow-right"></i>';
                this.setAttribute("aria-expanded", "false");
            }

            // Re-layout grid after expand/collapse
            setTimeout(() => msnry.layout(), 300);
        });
    });
});
</script>

{% endblock %}
